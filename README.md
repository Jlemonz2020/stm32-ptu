# 🎯 STM32二维云台控制系统

基于STM32F407的二维云台精确控制系统，使用PID算法实现视觉目标自动跟踪和锁定。

---

## 📋 项目概况

本项目实现了一个完整的二维云台自动跟踪系统，通过MaixCAM视觉模块识别目标，STM32进行PID控制，驱动张大头闭环步进电机实现精确跟踪。系统采用FreeRTOS实时操作系统，控制频率50Hz，定位精度±8像素。

**主要特性**
- 双轴独立PID控制（水平+垂直）
- 实时串口参数调整，无需重新编译
- 三级调试输出控制（debug/log/cam）
- 智能锁定检测（连续10次在死区内）
- 云台自检功能（上电自动测试）

**性能指标**
- 控制频率: 50Hz (20ms周期)
- 响应时间: <1秒
- 定位精度: ±8像素
- 锁定时间: 200ms

---

## 🛠️ 硬件组成

### 主控单元
- **型号**: STM32F407VET6
- **架构**: ARM Cortex-M4
- **主频**: 168MHz
- **Flash**: 512KB
- **SRAM**: 192KB

### 视觉模块
- **型号**: MaixCAM
- **分辨率**: 240x240
- **接口**: UART (USART1)
- **波特率**: 115200
- **数据格式**: "X,Y\n"

### 执行机构
- **型号**: 张大头42步闭环步进电机
- **细分**: 16细分
- **精度**: 3200脉冲/圈
- **速度**: 1200 RPM
- **加速度**: 5级
- **接口**: UART (USART3/USART6)
- **协议**: 自定义串口协议
- **校验**: 固定0x6B

### 硬件连接

| 设备 | UART | STM32引脚 | 波特率 | 说明 |
|------|------|----------|--------|------|
| MaixCAM | USART1 | PA9(TX), PA10(RX) | 115200 | 接收目标坐标 |
| 串口调试 | USART2 | PA2(TX), PA3(RX) | 115200 | 参数调整和监控 |
| X轴电机(ID=2) | USART3 | PB10(TX), PB11(RX) | 115200 | 水平轴控制 |
| Y轴电机(ID=1) | USART6 | PC6(TX), PC7(RX) | 115200 | 垂直轴控制 |

---

## 💻 开发平台

### 软件环境
- **IDE**: Keil MDK-ARM v5
- **操作系统**: FreeRTOS
- **HAL库**: STM32F4 HAL Driver
- **配置工具**: STM32CubeMX

### 开发语言
- **主要语言**: C
- **标准**: C99

### 编译配置
- **优化等级**: -O2
- **浮点运算**: 硬件FPU
- **调试接口**: SWD

---

## 📟 串口命令使用

### 连接设置
- **串口**: USART2
- **波特率**: 115200
- **数据位**: 8
- **停止位**: 1
- **校验**: 无

### 基本命令

```bash
help                    # 显示所有命令
status                  # 显示系统状态和PID参数
```

### 系统控制

```bash
enable                  # 启动云台跟踪
disable                 # 停止云台跟踪
test                    # 运行云台自检（左右30°，上下15°）
stop                    # 停止所有电机
```

### PID参数调整

```bash
pid h <kp> <ki> <kd>    # 设置水平轴PID参数
pid v <kp> <ki> <kd>    # 设置垂直轴PID参数

# 示例
pid h 150 0 0           # 设置水平轴纯P控制
pid v 150 0.5 10        # 设置垂直轴PID控制
```

**参数说明**:
- `Kp`: 比例系数，越大响应越快，过大会震荡
- `Ki`: 积分系数，消除稳态误差，过大会积分饱和
- `Kd`: 微分系数，抑制超调，过大会放大噪声

**默认参数**: Kp=150, Ki=0, Kd=0

### 手动电机控制

```bash
move h <angle>          # 水平移动（正=右，负=左）
move v <angle>          # 垂直移动（正=上，负=下）

# 示例
move h 30               # 右转30度
move v -15              # 下转15度
```

### 调试输出控制

```bash
debug on/off            # 数据反馈开关
log on/off              # 云台调试开关
cam on/off              # 相机调试开关
```

**输出说明**:
- `debug on`: 输出格式化数据 `DATA,target_x,target_y,dx,dy,pid_h,pid_v,state`
- `log on`: 输出跟踪信息、锁定状态、PID输出
- `cam on`: 输出相机接收的原始数据

**默认状态**: 全部关闭

### 使用示例

```bash
# 初次使用
help                    # 查看帮助
test                    # 运行自检
enable                  # 启动跟踪

# 调试模式
log on                  # 开启调试输出
debug on                # 开启数据反馈
status                  # 查看当前状态

# 参数调整
disable                 # 停止跟踪
pid h 180 0 0           # 增大Kp提高响应速度
enable                  # 重新启动跟踪

# 手动测试
move h 10               # 测试水平轴
move v 10               # 测试垂直轴
stop                    # 停止电机
```

---

## 📁 文件结构

```
.
├── APP/                        # 应用层代码
│   ├── PID.c/h                # PID控制器实现
│   ├── Camera.c/h             # 视觉数据接收与解析
│   ├── Motor.c/h              # 电机驱动与协议封装
│   ├── GimbalControl.c/h      # 云台控制逻辑
│   └── SerialDebug.c/h        # 串口调试系统
│
├── Core/                       # STM32核心代码
│   ├── Inc/                   # 头文件
│   │   ├── main.h
│   │   ├── stm32f4xx_it.h
│   │   ├── FreeRTOSConfig.h
│   │   └── ...
│   └── Src/                   # 源文件
│       ├── main.c
│       ├── stm32f4xx_it.c
│       ├── freertos.c
│       └── ...
│
├── Drivers/                    # HAL驱动库
│   ├── STM32F4xx_HAL_Driver/  # STM32 HAL库
│   └── CMSIS/                 # CMSIS标准库
│
├── Middlewares/                # 中间件
│   └── FreeRTOS/              # FreeRTOS源码
│
├── MDK-ARM/                    # Keil工程文件
│   └── PTU.uvprojx            # Keil工程
│
├── maixcam.py                  # MaixCAM视觉识别脚本
├── pc_monitor.py               # PC端监控工具（可选）
├── test_uart.py                # 串口测试工具（可选）
│
├── README.md                   # 项目说明文档
└── ROADMAP.md                  # 项目路线图
```

### 核心模块说明

**APP/PID.c/h**
- 标准PID算法实现
- 支持死区处理
- 积分限幅和输出限幅
- 实时参数调整

**APP/Camera.c/h**
- 接收MaixCAM发送的目标坐标
- 数据格式解析 "X,Y\n"
- 计算相对于屏幕中心的偏差
- 数据验证和范围检查

**APP/Motor.c/h**
- 张大头电机协议实现
- 位置模式控制
- 双向运动控制（CW/CCW）
- 通信校验保护

**APP/GimbalControl.c/h**
- 50Hz控制任务
- 双轴独立PID控制
- 锁定检测（连续10次在死区内）
- 状态管理（IDLE/TRACKING/LOCKED）

**APP/SerialDebug.c/h**
- 串口命令解析
- 实时参数调整
- 三级调试输出控制
- 数据反馈功能

---

## 🔄 版本迭代

### v1.0 (2026-02-25) - 当前版本

**核心功能**
- ✅ 完整的PID控制系统
- ✅ 双轴独立控制
- ✅ 支持张大头42步闭环步进电机
- ✅ 支持MaixCAM 240x240视觉识别
- ✅ 完整的串口命令系统
- ✅ 独立的log/debug/cam调试控制
- ✅ 云台自检功能
- ✅ 高速响应（Kp=150, 1200RPM）
- ✅ 实时参数调整，无需重新编译

**技术参数**
- 控制频率: 50Hz
- PID参数: Kp=150, Ki=0, Kd=0
- 死区: ±8像素
- 电机速度: 1200 RPM
- 加速度: 5级

**已知问题**
- 纯P控制存在稳态误差（3-5像素）
- 无数据校验机制
- 无通信超时保护
- 无电机反馈
- 详见 [ROADMAP.md](ROADMAP.md)

### v1.1 (计划中)

**通信优化**
- [ ] 添加数据校验（CRC8）
- [ ] 实现超时检测和保护
- [ ] 增加电机状态反馈
- [ ] 优化缓冲区管理

**算法优化**
- [ ] 添加积分项消除稳态误差
- [ ] 实现自适应死区
- [ ] 添加简单目标预测
- [ ] 优化PID参数自动调整

**预期效果**
- 控制周期: 20±2ms (稳定)
- 响应时间: 500-800ms
- 定位精度: ±5像素
- 稳态误差: <2像素
- 锁定成功率: >95%

---

## 🚀 快速开始

### 1. 硬件准备
- STM32F407开发板
- MaixCAM视觉模块
- 张大头42步闭环步进电机 x2
- USB转TTL串口模块（调试用）

### 2. 软件准备
- Keil MDK-ARM v5
- STM32CubeMX（可选）
- 串口调试工具

### 3. 编译烧录
1. 打开 `MDK-ARM/PTU.uvprojx`
2. 编译工程（F7）
3. 烧录到STM32（F8）

### 4. 配置MaixCAM
1. 将 `maixcam.py` 上传到MaixCAM
2. 在MaixVision IDE中运行
3. MaixCAM会通过UART0发送目标坐标

### 5. 开始使用
1. 连接串口调试工具（USART2, 115200）
2. 输入 `help` 查看命令
3. 输入 `test` 运行自检
4. 输入 `enable` 启动跟踪

---

## 📞 技术支持

### 调试步骤
1. 连接串口（USART2，115200）
2. 输入 `help` 查看所有命令
3. 输入 `test` 运行自检
4. 输入 `log on` 开启调试输出
5. 输入 `status` 查看系统状态
6. 输入 `enable` 启动跟踪

### 常见问题

**云台不动？**
```bash
enable          # 确认已启动跟踪
log on          # 开启调试输出查看状态
cam on          # 检查是否收到相机数据
status          # 查看系统状态
```

**没有收到相机数据？**
- 检查MaixCAM是否运行 `maixcam.py`
- 检查USART1连接（PA9/PA10）
- 确认MaixCAM波特率为115200

**响应太慢或震荡？**
```bash
# 响应慢：增大Kp
pid h 180 0 0

# 震荡：减小Kp
pid h 120 0 0

# 稳态误差：添加积分
pid h 150 0.5 0
```

---

## 📄 许可证

本项目采用 MIT 许可证

---

**当前版本**: v1.0  
**最新更新**: 2026-02-25  
**维护者**: Jlemonz
