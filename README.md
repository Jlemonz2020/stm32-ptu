# 🎯 STM32二维云台控制系统

基于STM32F407的二维云台精确控制系统，使用PID算法实现视觉目标自动跟踪和锁定。

---

## 📋 项目概述

本项目实现了一个完整的二维云台控制系统，支持MaixCAM视觉识别和张大头42步闭环步进电机。系统采用FreeRTOS实时操作系统，50Hz控制频率，定位精度±8像素。

### 主要特性

- ✅ 双轴独立PID控制（水平+垂直）
- ✅ 50Hz高频控制，快速响应（Kp=150, 1200RPM）
- ✅ 智能锁定检测，精度±8像素
- ✅ 串口实时参数调整，无需重新编译
- ✅ 完整的调试输出控制系统
- ✅ 云台自检功能

---

## 🛠️ 硬件配置

### 主控
- **MCU**: STM32F407VET6
- **操作系统**: FreeRTOS

### 外设连接

| 设备 | UART | STM32引脚 | 波特率 | 说明 |
|------|------|----------|--------|------|
| MaixCAM视觉模块 | USART1 | PA9(TX), PA10(RX) | 115200 | 接收目标坐标 |
| 串口调试 | USART2 | PA2(TX), PA3(RX) | 115200 | 参数调整和监控 |
| X轴电机(ID=2) | USART3 | PB10(TX), PB11(RX) | 115200 | 水平轴控制 |
| Y轴电机(ID=1) | USART6 | PC6(TX), PC7(RX) | 115200 | 垂直轴控制 |

### 电机参数
- **型号**: 张大头42步闭环步进电机
- **细分**: 16细分，3200脉冲/圈
- **速度**: 1200 RPM
- **加速度**: 5级
- **控制模式**: 位置模式 (0xFD)
- **校验**: 固定0x6B

---

## 🚀 快速开始

### 1. 编译烧录

1. 在Keil中打开项目
2. 确认以下文件已添加到项目：
   ```
   APP/PID.c
   APP/GimbalControl.c
   APP/Camera.c
   APP/Motor.c
   APP/SerialDebug.c
   ```
3. 编译（F7）并烧录（F8）到STM32

### 2. 配置MaixCAM

1. 将 `maixcam.py` 上传到MaixCAM
2. 在MaixVision IDE中运行
3. MaixCAM会通过UART0发送目标坐标 "X,Y\n"

### 3. 连接调试

1. 使用串口工具连接USART2（115200, 8N1）
2. STM32上电后自动执行云台自检
3. 输入 `help` 查看所有命令

---

## 📟 串口命令

### 基本命令

| 命令 | 说明 | 示例 |
|------|------|------|
| `help` | 显示所有命令 | `help` |
| `status` | 显示系统状态和PID参数 | `status` |

### 系统控制

| 命令 | 说明 | 示例 |
|------|------|------|
| `enable` | 启动云台跟踪 | `enable` |
| `disable` | 停止云台跟踪 | `disable` |
| `test` | 运行云台自检（左右30°，上下15°） | `test` |
| `stop` | 停止所有电机 | `stop` |

### PID参数调整（实时生效，无需重新编译）

| 命令 | 说明 | 示例 |
|------|------|------|
| `pid h <kp> <ki> <kd>` | 设置水平轴PID参数 | `pid h 150 0 0` |
| `pid v <kp> <ki> <kd>` | 设置垂直轴PID参数 | `pid v 150 0 0` |

**PID参数说明**：
- `Kp`: 比例系数，越大响应越快，过大会震荡
- `Ki`: 积分系数，消除稳态误差，过大会积分饱和
- `Kd`: 微分系数，抑制超调，过大会放大噪声

**默认参数**：`Kp=150, Ki=0, Kd=0`（纯P控制）

### 手动电机控制

| 命令 | 说明 | 示例 |
|------|------|------|
| `move h <angle>` | 水平移动（正=右，负=左） | `move h 30` |
| `move v <angle>` | 垂直移动（正=上，负=下） | `move v -15` |

### 调试输出控制（默认全部关闭）

| 命令 | 说明 | 输出内容 |
|------|------|----------|
| `debug on/off` | 数据反馈开关 | `DATA,target_x,target_y,dx,dy,pid_h,pid_v,state` |
| `log on/off` | 云台调试开关 | 跟踪信息、锁定状态、PID输出 |
| `cam on/off` | 相机调试开关 | `[CAM RX]` 原始数据、目标坐标 |

---

## 🎯 使用流程

### 初次使用

```bash
# 1. 连接串口，查看帮助
help

# 2. 运行自检，确认电机正常
test

# 3. 手动测试电机方向
move h 10
move v 10

# 4. 启动跟踪
enable

# 5. 开启调试输出（可选）
log on
debug on
```

### 调参流程

```bash
# 1. 停止跟踪
disable

# 2. 查看当前参数
status

# 3. 调整PID参数
pid h 150 0 0

# 4. 开启调试输出
log on

# 5. 启动跟踪，观察效果
enable

# 6. 根据输出调整参数
# - 响应慢：增大Kp
# - 震荡：减小Kp
# - 稳态误差：增加Ki
# - 超调：增加Kd
```

### 常用调试组合

```bash
# 查看所有信息（调试时）
log on
debug on
cam on

# 只看数据反馈（正常使用）
debug on

# 关闭所有输出（清爽模式）
log off
debug off
cam off
```

---

## 🔧 技术要点

### 1. 系统架构

```
MaixCAM(USART1) → 目标坐标 → 偏差计算 → PID控制 → 电机驱动(USART3/6)
   240x240          X,Y\n      dx,dy      Kp=150    张大头电机
                                    ↓
                            串口调试(USART2)
                            实时参数调整
```

### 2. 控制算法

**PID控制器**
- 双轴独立控制（水平轴 + 垂直轴）
- 控制频率：50Hz（20ms周期）
- 死区设置：±8像素（避免微小抖动）
- 锁定判定：连续10次在死区内（200ms）

**控制流程**
```c
1. 接收MaixCAM目标坐标 (X, Y)
2. 计算偏差: dx = X - 120, dy = Y - 120
3. PID计算: output = Kp * error
4. 电机控制: Motor_Move(output * 0.01)
5. 锁定检测: 连续10次在死区内
```

### 3. 通信协议

**视觉通信（USART1）**
```
格式: "X,Y\n"
示例: "113,114\n"
说明: X,Y为目标在240x240图像中的坐标
     (0,0)表示无目标
```

**电机协议（USART3/6）**
```
位置模式: [ID][0xFD][速度高][速度低][加速度][脉冲高][脉冲低][方向][0x6B]
停止命令: [ID][0xFE][0x6B]
使能命令: [ID][0xF3][0x01][0x6B]

ID: 1=Y轴(垂直), 2=X轴(水平)
方向: 0x00=CCW(逆时针), 0x01=CW(顺时针)
校验: 固定0x6B
```

### 4. 模块设计

```
APP/
├── Camera.c/h          # 视觉数据接收与解析
│   ├── 接收MaixCAM坐标数据
│   ├── 数据验证和范围检查
│   └── 计算相对于中心的偏差
│
├── Motor.c/h           # 电机驱动与协议封装
│   ├── 张大头电机协议实现
│   ├── 位置模式控制
│   └── 双向运动控制
│
├── PID.c/h             # PID控制器实现
│   ├── 双轴独立PID
│   ├── 死区处理
│   └── 参数实时调整
│
├── GimbalControl.c/h   # 云台控制逻辑
│   ├── 50Hz控制任务
│   ├── 锁定检测
│   └── 状态管理
│
└── SerialDebug.c/h     # 串口调试系统
    ├── 命令解析
    ├── 参数调整
    └── 调试输出控制
```

### 5. 关键特性

**实时参数调整**
- 无需重新编译即可调整PID参数
- 支持运行时修改死区、速度等参数
- 提高调试效率

**三级调试控制**
- `debug`: 数据反馈（DATA格式）
- `log`: 云台调试信息
- `cam`: 相机接收调试
- 默认全部关闭，按需开启

**智能锁定检测**
- 连续10次在死区内判定为锁定
- 锁定后停止电机，节省功耗
- 目标移动时自动恢复跟踪

**云台自检**
- 上电自动执行
- 测试序列：左30° → 右30° → 上15° → 下15°
- 验证电机连接和运动范围

---

## 📊 性能指标

| 指标 | 数值 |
|------|------|
| 控制频率 | 50Hz (20ms周期) |
| 响应时间 | <1秒到达目标附近 |
| 定位精度 | ±8像素 |
| 锁定判定 | 连续10次在死区内 (200ms) |
| 电机速度 | 1200 RPM |
| 通信波特率 | 115200 bps |

---

## 🔍 调试输出示例

### 数据反馈（debug on）
```
DATA,165,158,5,-2,500.0,-200.0,1
DATA,162,160,2,0,200.0,0.0,1
```
格式：`DATA,target_x,target_y,dx,dy,pid_h,pid_v,state`

### 云台调试（log on）
```
Track: Pos[165,158] Delta[+5,-2] PID[500.0,-200.0]
Track: Pos[162,160] Delta[+2,0] PID[200.0,0.0]
>>> LOCKED at [160,160] <<<
```

### 相机调试（cam on）
```
[CAM RX] Raw: "113,114" -> X=113 Y=114
[CAM] Target valid: (113,114)
```

---

## ⚠️ 常见问题

### 云台不动？
```bash
# 1. 检查是否启动跟踪
enable

# 2. 开启调试输出查看状态
log on
cam on

# 3. 查看系统状态
status

# 4. 手动测试电机
move h 10
move v 10
```

### 没有收到相机数据？
- 检查MaixCAM是否运行 `maixcam.py`
- 检查USART1连接（PA9/PA10）
- 输入 `cam on` 查看接收状态
- 确认MaixCAM波特率为115200

### 电机方向错误？
- 电机方向已在代码中配置
- 如需修改，编辑 `APP/Motor.c` 中的 `DIR_CW` 和 `DIR_CCW`

### 调试输出太多？
```bash
# 关闭所有调试输出
log off
debug off
cam off
```

### 响应太慢或震荡？
```bash
# 响应慢：增大Kp
pid h 180 0 0

# 震荡：减小Kp
pid h 120 0 0

# 稳态误差：添加积分
pid h 150 0.5 0

# 超调：添加微分
pid h 150 0 20
```

---

## 📁 项目文件

```
.
├── APP/                    # 应用层代码
│   ├── Camera.c/h         # 视觉数据处理
│   ├── Motor.c/h          # 电机驱动
│   ├── PID.c/h            # PID控制器
│   ├── GimbalControl.c/h  # 云台控制
│   └── SerialDebug.c/h    # 串口调试
├── Core/                   # STM32核心代码
├── Drivers/                # HAL驱动库
├── Middlewares/            # FreeRTOS
├── maixcam.py             # MaixCAM视觉识别脚本
├── pc_monitor.py          # PC端监控工具（可选）
├── test_uart.py           # 串口测试工具（可选）
└── README.md              # 本文档
```

---

## 🎓 技术亮点

1. **模块化设计**：各模块职责清晰，易于维护和扩展
2. **实时参数调整**：无需重新编译，提高调试效率
3. **三级调试控制**：灵活的调试输出管理
4. **完整的错误处理**：数据验证、范围检查、通信校验
5. **FreeRTOS任务管理**：保证实时性和系统稳定性
6. **智能锁定检测**：节省功耗，提高系统效率

---

## 📝 版本历史

### v1.0 (2026-02-25)
- ✅ 移除WiFi/ESP8266，改用串口调试
- ✅ 支持张大头42步闭环步进电机
- ✅ 支持MaixCAM 240x240视觉识别
- ✅ 完整的串口命令系统
- ✅ 独立的log/debug/cam调试控制
- ✅ 云台自检功能
- ✅ 高速响应（Kp=150, 1200RPM）

---

**串口命令控制，实时调参，简单高效！🎉**
